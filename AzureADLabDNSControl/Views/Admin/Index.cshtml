@{
    ViewBag.Title = "Lab Admin";
}

<div class="panel panel-primary" style="margin-top:10px;position:relative;">
    <div class="panel-heading">
        <button id="btnAddLab" type="button" class="btn btn-xs btn-default control pull-right"><span class="glyphicon glyphicon-plus"></span> New...</button>
        @ViewBag.Title
    </div>
    <div class="panel-body">
        <div class="col-sm-3">
            <div class="scrollWrap">
                <ul id="labList" class="nav nav-pills nav-stacked"></ul>
            </div>
        </div>
        <div id="labDetailsInfo" class="col-sm-9 details">
            Select a lab from the left to view details.
        </div>
        <div id="labDetails" class="col-sm-9 details" style="display:none">
            <div class="row">
                <div class="col-sm-3 lbl">
                    <div class="lbl">Instructor</div>
                    <div class="lbl">Date</div>
                    <div class="lbl">City</div>
                    <div class="lbl">Lab Code</div>
                    <div class="lbl">Additional Instructors</div>
                </div>
                <div class="col-sm-7">
                    <div id="labInstructor"></div>
                    <div id="labLabDate"></div>
                    <div id="labCity"></div>
                    <div id="labLabCode"></div>
                    <div class="wordwrap" id="labInstructors"></div>
                </div>
                <div class="col-sm-2 buttons">
                    <button id="btnEditLab" class="btn btn-warning"><span class="glyphicon glyphicon-cog"></span> Edit...</button>
                    <button id="btnReport" class="btn btn-info"><span class="glyphicon glyphicon-blackboard"></span> Print Report...</button>
                    <button id="btnClose" class="btn btn-info"><span class="glyphicon glyphicon-check"></span> Close</button>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12" style="margin-top:8px;">
                    <label>Team List</label>
                    <div id="tableScroll">
                        <table class="table table-bordered table-striped table-responsive" id="labTeamList">
                            <tr>
                                <td>Domain</td>
                                <td>Team Auth</td>
                                <td>TXT Record</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" id="EditLab">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Edit Lab</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div id="dtPicker" class="col-sm-6">
                        <label for="LabDate">Lab Date</label>
                        <div class="input-group date" id="datepickerLab">
                            <input type="text" class="form-control max" style="display:inline-block" id="LabDate" />
                            <span class="input-group-addon">
                                <span class="glyphicon-calendar glyphicon"></span>
                            </span>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <label for="City">City</label>
                        <input type="text" class="form-control max" style="display:inline-block" id="City" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <label for="Instructor">Instructor</label>
                        <input type="text" class="form-control max" style="display:inline-block" id="Instructor" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <label for="Instructors">Additional Instructors <span class="hint">(tab after each alias)</span></label>
                        <input type="text" class="form-control max" id="Instructors" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="btnSaveLab">Save</button>
                <button type="button" class="btn btn-danger" id="btnDeleteLab">Delete</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>


@section scripts {
    <script type="text/javascript" src="~/Scripts/bootstrap-tokenfield.min.js"></script>
    <script type="text/javascript">
        var labsList = [];
        var me = "@User.Identity.Name";
        $(function () {
            $("#btnClose").on("click", function () {
                $("#labList li").removeClass("active");
                setDetail();
                $("#labDetails").data("data", null).css("display", "none");
                $("#labDetailsInfo").css("display", "block");

            });
            $("#btnAddLab").on("click", function () {
                loadLabForm();
            });
            $("#btnEditLab").on("click", function () {
                var data = $("#labDetails").data("data");
                loadLabForm(data);
            });
            $("#btnReport").on("click", function () {
                var id = $("#labDetails").data("data").id;
                location.href = "/Admin/LabReport/" + id;
            });
            $("#labList").on("click", "li:not(.info)", function () {
                $("#labList li").removeClass("active");
                $(this).addClass("active");
                var id = $(this).data("id");
                getLab(id);
            });
            $("#btnSaveLab").on("click", saveLab);
            $("#btnDeleteLab").on("click", deleteLab);

            function deleteLab() {
                if (!confirm("Are you sure you want to delete this lab?"))
                    return;

                var data = $("#labDetails").data("data");
                SiteUtil.AjaxCall("/api/Lab/DeleteLab/" + data.id, null, function (res) {
                    $("#EditLab").modal('hide');
                   loadLabList(res);
                   setDetail(null);
                }, "POST");

            }
            function saveLab(data) {
                var action = (($("#myModalLabel").html() == "Add Lab") ? "AddLab" : "UpdateLab");
                var data = {};
                if (action == "AddLab") {
                    data = {
                        "primaryInstructor": $("#Instructor").val(),
                        "labDate": $("#LabDate").val(),
                        "city": $("#City").val(),
                    }
                } else {
                    data = $("#labDetails").data("data");
                    data.primaryInstructor = $("#Instructor").val();
                    data.labDate = $("#LabDate").val();
                    data.city = $("#City").val();
                }

                data.instructors = $('#Instructors').tokenfield('getTokensList', ',', false, false).split(",");

                SiteUtil.AjaxCall("/api/Lab/" + action, JSON.stringify(data), function (res) {
                    $("#EditLab").modal('hide');
                    loadLabList(res);
                    getLab(data.id);
                }, "POST");
            }

            function loadLabForm(data) {
                $("#myModalLabel").html((data == null) ? "Add Lab" : "Edit Lab");

                $("#Instructor").val((data == null) ? me : data.primaryInstructor);
                $("#LabDate").val((data == null) ? moment().format("MM/DD/YYYY") : SiteUtil.GetShortDate(data.labDate));
                $("#City").val((data == null) ? "" : data.city);
                if (data != null) {
                    $('#Instructors').tokenfield('setTokens', data.instructors);
                } else {
                    $("#Instructors").tokenfield('setTokens', []);
                }
                $("#EditLab").modal('show');
            }
            function getLabList() {
                SiteUtil.AjaxCall("/api/Lab/GetLabs", null, function (res) {
                    labsList = res;
                    loadLabList(res);
                });
            }
            function getLab(id) {
                SiteUtil.AjaxCall("/api/Lab/GetLab/" + id, null, function (res) {
                    setDetail(res);
                });
            }
            function setDetail(data) {
                if (data == null || typeof (data) == "undefined") {
                    $("#labDetails").data("data", null).css("display", "none");
                    $("#labDetailsInfo").css("display", "block");
                } else {
                    $("#labDetails").data("data", data).css("display", "block");
                    $("#labDetailsInfo").css("display", "none");
                }
                $("#labInstructor").html((data == null) ? "" : data.primaryInstructor);
                $("#labLabDate").html((data == null) ? "" : SiteUtil.GetShortDate(data.labDate));
                $("#labCity").html((data == null) ? "" : data.city);
                $("#labLabCode").html((data == null) ? "" : data.labCode);
                $("#labInstructors").html((data == null) ? "" : data.instructors.join(", "));
                $("#labTeamList tr:not(:first-child)").remove();

                if (data == null) return;
                for (var x = 0; x < data.domAssignments.length; x++) {
                    var tr = $("<tr/>");
                    $("<td/>").html(data.domAssignments[x].domainName).appendTo(tr);
                    $("<td/>").html(data.domAssignments[x].teamAuth).appendTo(tr);
                    $("<td/>").html(data.domAssignments[x].dnsTxtRecord || "(not assigned)").appendTo(tr);
                    tr.css("cursor","pointer").attr("title", "Click to reset the Team Auth and TXT Records").data("data", data.domAssignments[x]).on("click", editAssignment).appendTo("#labTeamList");
                }
            }
            function editAssignment() {
                if (!confirm("Are you sure you want to assign this team a new auth code, and clear any existing TXT record from DNS?"))
                    return;

                var dom = $(this).data("data");
                var lab = $("#labDetails").data("data");
                var teamDto = {
                    "Lab": lab,
                    "TeamAssignment": dom
                }
                SiteUtil.AjaxCall("/api/Lab/ResetAssignment", JSON.stringify(teamDto), function (res) {
                    setDetail(res);
                }, "POST");
            }

            function checkLabDate(labDate, callback) {
                SiteUtil.AjaxCall("/api/Lab/CheckLabDate", labDate, function (res) {
                    callback(res);
                });
            }
            function getAllLabDates(callback) {
                SiteUtil.AjaxCall("/api/Lab/GetLabDates", null, function (res) {
                    callback(res);
                });
            }
            function loadLabList(res) {
                $("#labList li").remove();
                if (res.length == 0) {
                    $("<li/>").addClass("info").attr("role", "presentation").html("No labs currently assigned").appendTo("#labList");
                    return;
                }
                for (var x = 0; x < res.length; x++) {
                    var li = $("<li/>")
                        .data("id", res[x].id)
                        .attr("role", "presentation")
                        .appendTo("#labList");
                    $("<a/>")
                        .html(SiteUtil.GetShortDate(res[x].labDate) + ": " + res[x].city)
                        .css("backgroundColor", (res[x].primaryInstructor == me) ? "rgba(246, 254, 246, 1)" : "aliceblue")
                        .appendTo(li);
                }
            }
            $('#datepickerLab').datetimepicker({
                    format: 'MM/DD/YYYY',
                    allowInputToggle: true
                })
                .on("dp.show", function (e) {
                    getAllLabDates(function (arr) {
                        var arr2 = [];
                        $(arr).each(function () {
                            arr2.push(moment(this));
                        });
                        $("#datepickerLab").data("DateTimePicker").disabledDates(arr2);
                    });
                });
            $('#Instructors').tokenfield({
                createTokensOnBlur: true,
                delimiter: [",", " "],
                inputType: "email"
            });

            //init
            getLabList();
        });
    </script>

}

@section styles {
    <link rel="stylesheet" href="~/Content/bootstrap-tokenfield.min.css" />
    <style type="text/css">
        .nav-pills > li.active > a, .nav-pills > li.active > a:hover, .nav-pills > li.active > a:focus {
            color: #808080;
        }

        span.glyphicon {
            cursor: pointer;
        }

        div.buttons button {
            width: 130px;
            margin-bottom: 4px;
        }

        div.panel-body {
            max-height: 600px;
        }

        #labTeamList tr:first-child td {
            font-weight: bold;
            background-color: #cacaca;
        }

        #labList li:not(.info) {
            cursor: pointer;
        }

        .btn {
            min-width: 80px;
        }

        div.scrollWrap {
            min-height: 300px;
            max-height: 550px;
            overflow: auto;
        }

        #tableScroll {
            min-height: 300px;
            max-height: 400px;
            width: 100%;
            overflow: auto;
        }

        div.details {
            min-height: 500px;
            border-left: 1px solid #dadada;
            padding-left: 6px;
        }

        div.lbl {
            font-weight: bold;
        }

        .tokenfield {
            min-height: 100px;
        }

        ul.nav-stacked li a {
            border: 1px solid #efefef;
        }

        .hint {
            font-size: .8em;
            font-style: italic;
            font-weight: normal;
        }

        #dtPicker .btn {
            min-width: unset !important;
        }
    </style>
}